name: Cloud Build

on:
  #push:
  #  branches: [ main ]
  workflow_dispatch:
    inputs:
      branch:
        description: "æ„å»ºåˆ†æ”¯"
        required: false
        default: "ai4x"

env:
  REGISTRY_REMOTE: ghcr.io
  LOCAL_TAG: whisper-live-kit

jobs:
  build-in-cloud:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      image_name_lower: ${{ steps.vars.outputs.image_name_lower }}
      short_sha: ${{ steps.vars.outputs.short_sha }}
      build_time: ${{ steps.vars.outputs.build_time }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'ai4x' }}

      - name: Set Variables
        id: vars
        run: |
          RAW_REPO="${{ github.repository }}"
          echo "image_name_lower=${RAW_REPO,,}" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_date=$(date '+%Y%m%d')" >> $GITHUB_OUTPUT
          echo "build_time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY_REMOTE }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push to GHCR
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY_REMOTE }}/${{ steps.vars.outputs.image_name_lower }}:latest
            ${{ env.REGISTRY_REMOTE }}/${{ steps.vars.outputs.image_name_lower }}:${{ steps.vars.outputs.short_sha }}

      - name: Create Release with Manual Pull Instructions
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.vars.outputs.build_date }}-${{ steps.vars.outputs.short_sha }}
          name: "WLK ASR é•œåƒæ„å»ºæˆåŠŸ - ${{ steps.vars.outputs.short_sha }}"
          body: |
            ## ğŸš€ äº‘ç«¯æ„å»ºå·²å®Œæˆ
            é•œåƒå·²æˆåŠŸæ¨é€åˆ° GitHub Container Registryã€‚
            
            - **é•œåƒåœ°å€:** `ghcr.io/${{ steps.vars.outputs.image_name_lower }}:latest`
            - **æ„å»ºæ—¶é—´:** ${{ steps.vars.outputs.build_time }}
            
            ---
            ## ğŸ›  æ‰‹åŠ¨åŒæ­¥åˆ°å±€åŸŸç½‘
            è¯·åœ¨æœ¬åœ°æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†é•œåƒåŒæ­¥åˆ°ç§æœ‰ä»“åº“ï¼š
            
            ```bash
            # 1. è®¾ç½®ä»£ç† (å¦‚æœéœ€è¦)
            export http_proxy=http://...
            export https_proxy=http://...
            
            # 2. ä» GitHub æ‹‰å–
            docker pull ghcr.io/${{ steps.vars.outputs.image_name_lower }}:latest
            
            # 3. å–æ¶ˆä»£ç†å¹¶æ‰“æ ‡æ¨é€è‡³æœ¬åœ°ä»“åº“
            unset http_proxy https_proxy
            docker tag ghcr.io/${{ steps.vars.outputs.image_name_lower }}:latest {registry_host}/${{ env.LOCAL_TAG }}:latest
            docker push {registry_host}/${{ env.LOCAL_TAG }}:latest
            
            # 4. æ¸…ç†æ®‹ç•™
            docker rmi ghcr.io/${{ steps.vars.outputs.image_name_lower }}:latest
            ```
